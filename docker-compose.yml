# Beehus App - Automation & Web Scraping Platform
# Compose Specification (https://docs.docker.com/compose/compose-file/)

name: beehus-app

x-chrome-node-env: &chrome-node-env
  SE_EVENT_BUS_HOST: selenium-hub
  SE_EVENT_BUS_PUBLISH_PORT: 4442
  SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
  SE_START_XVFB: "true"
  SE_START_VNC: "true"
  SE_VNC_NO_PASSWORD: "1"
  SE_NODE_MAX_SESSIONS: "1"
  SE_NODE_OVERRIDE_MAX_SESSIONS: "true"

x-chrome-node: &chrome-node
  image: selenium/node-chrome:4.39.0
  shm_size: 2g
  mem_limit: 2g
  cpus: "1.0"
  depends_on:
    - selenium-hub
  volumes:
    - ${DOWNLOADS_DIR:-./downloads}:/downloads
  networks:
    - scrape-net
  healthcheck:
    test: ["CMD-SHELL", "curl -fsS http://localhost:5555/status || exit 1"]
    interval: 20s
    timeout: 5s
    retries: 5

services:
  mongo:
    image: mongo:6-jammy
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS:-adminpass}
    # Ports removed for security (exposed in override only)
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - scrape-net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    # Ports removed for security (exposed in override only)
    networks:
      - scrape-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: always
    # Ports removed for security (exposed in override only)
    networks:
      - scrape-net

  # --- Infrastructure ---

  # Selenium Grid Hub
  selenium-hub:
    image: selenium/hub:4.39.0
    container_name: beehus-app-selenium-hub
    ports:
      - "4444:4444"
    networks:
      - scrape-net

  # Selenium Chrome Nodes (2 replicas for concurrent execution)
  chrome-node-1:
    <<: *chrome-node
    ports:
      - "7902:7900"
    environment:
      <<: *chrome-node-env
      SE_NODE_HOST: chrome-node-1
      SE_NODE_PORT: "5555"

  chrome-node-2:
    <<: *chrome-node
    ports:
      - "7903:7900"
    environment:
      <<: *chrome-node-env
      SE_NODE_HOST: chrome-node-2
      SE_NODE_PORT: "5555"

  # Celery Worker (Local Execution + Evasion)
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    # Reduced concurrency to 1 for memory optimization (jobs are I/O bound)
    command: celery -A core.celery_app worker --concurrency=1 --loglevel=info
    restart: unless-stopped
    ports:
      - "5901:5900"
      - "7901:6901" # Host 7901 -> Worker NoVNC 6901 (JP Morgan Specific)
    shm_size: 2g
    volumes:
      - .:/app
      - ./artifacts:/app/artifacts
      - ${DOWNLOADS_DIR:-./downloads}:/downloads
    env_file:
      - .env
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    networks:
      - scrape-net

  # Celery Beat (scheduler)
  celery-beat:
    build: .
    command: celery -A django_config beat --loglevel=info -S core.celery_scheduler.MongoScheduler
    restart: unless-stopped
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongo:
        condition: service_healthy
    networks:
      - scrape-net

  # Flower (Celery monitoring) - DISABLED for memory optimization
  # Uncomment only when debugging. Use CLI monitoring instead:
  # docker exec beehus-app-celery-worker-1 celery -A core.celery_app inspect active
  # flower:
  #   build: .
  #   command: celery -A core.celery_app flower --port=5555
  #   restart: unless-stopped
  #   ports:
  #     - "5555:5555"
  #   env_file:
  #     - .env
  #   depends_on:
  #     - celery-worker
  #   networks:
  #     - scrape-net

  app-console:
    build: .
    command: uvicorn app.console.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - scrape-net

  frontend:
    build: 
      context: ./beehus-web
      dockerfile: Dockerfile
    working_dir: /app
    command: sh -c "npm install && rm -rf node_modules/.vite && npm rebuild esbuild && npm run dev -- --host"
    volumes:
      - ./beehus-web:/app
      - /app/node_modules
    ports:
      - "5173:5173"  # Same port inside/outside - no confusion!
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - app-console
    networks:
      - scrape-net


volumes:
  mongo_data:

networks:
  scrape-net:
    driver: bridge
